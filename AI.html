<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>SiliconFlow AI 聊天（localStorage版）</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #chat-log {
      border: 1px solid #ccc;
      padding: 10px;
      height: 300px;
      overflow-y: auto;
      margin-bottom: 10px;
      white-space: pre-wrap;
    }
    .user-msg {
      color: blue;
      margin: 5px 0;
    }
    .ai-msg {
      color: green;
      margin: 5px 0;
    }
    .ai-reasoning {
      color: gray;
      margin: 5px 0;
    }
    .timestamp {
      font-size: 0.8em;
      color: #666;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <h1>SiliconFlow AI 聊天</h1>
  <div id="chat-log"></div>
  <textarea id="user-input" rows="3" cols="50" placeholder="请输入你的消息..."></textarea>
  <br>
  <button id="send-btn">发送</button>
  <button id="clear-btn">清除聊天记录</button>

  <script>
    // SiliconFlow API 接口地址和 API 密钥
    const apiEndpoint = 'https://api.siliconflow.ai/chat';
    const apiKey = 'sk-mskdymxqaveuuwxryoxlkjquzujocjddcxlacuawgppxrnjs';

    // 获取页面元素
    const chatLog = document.getElementById('chat-log');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const clearBtn = document.getElementById('clear-btn');

    // 全局聊天记录数组，每条记录包含：sender, message, timestamp
    let chatHistory = [];

    // 将聊天记录保存到 localStorage
    function updateLocalStorage() {
      localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
    }

    // 加载 localStorage 中的聊天记录
    function loadChatHistory() {
      const storedHistory = localStorage.getItem('chatHistory');
      if (storedHistory) {
        chatHistory = JSON.parse(storedHistory);
        chatHistory.forEach(record => {
          appendMessage(record.sender, record.message, record.timestamp, false);
        });
      }
    }

    // 辅助函数：格式化时间戳
    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString();
    }

    // 辅助函数：在聊天记录中追加消息，并保存记录
    // 参数 saveRecord 控制是否更新 chatHistory（false 时用于页面加载时恢复记录，不重复保存）
    function appendMessage(sender, message, timestamp = Date.now(), saveRecord = true) {
      const messageElem = document.createElement('p');
      // 根据发送者设定不同样式
      let className = '';
      if (sender === '用户') {
        className = 'user-msg';
      } else if (sender === 'AI') {
        className = 'ai-msg';
      } else if (sender === 'AI（推理中）') {
        className = 'ai-reasoning';
      }
      messageElem.className = className;
      messageElem.innerHTML = `<strong>${sender}:</strong> ${message} <span class="timestamp">[${formatTimestamp(timestamp)}]</span>`;
      chatLog.appendChild(messageElem);
      chatLog.scrollTop = chatLog.scrollHeight;

      if (saveRecord) {
        chatHistory.push({ sender, message, timestamp });
        updateLocalStorage();
      }
    }

    // 主函数：发送消息并处理流式响应
    async function sendMessage(message) {
      // 记录用户消息
      appendMessage("用户", message);
      userInput.value = ""; // 清空输入框

      // 构造请求体，根据 API 要求调整参数
      const payload = {
        message: message,
        stream: true
      };

      try {
        const response = await fetch(apiEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + apiKey
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          appendMessage("AI", "错误: " + response.statusText);
          return;
        }

        // 处理流式输出
        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let aiContent = "";
        // 创建用于显示推理过程的占位元素
        const reasoningElem = document.createElement('p');
        reasoningElem.className = 'ai-reasoning';
        reasoningElem.innerHTML = `<strong>AI（推理中）:</strong> `;
        chatLog.appendChild(reasoningElem);
        chatLog.scrollTop = chatLog.scrollHeight;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, { stream: true });
          aiContent += chunk;
          reasoningElem.innerHTML = `<strong>AI（推理中）:</strong> ${aiContent}`;
        }
        // 推理完成后移除占位元素，保存最终回复
        reasoningElem.remove();
        appendMessage("AI", aiContent);
      } catch (error) {
        console.error(error);
        appendMessage("AI", "错误: " + error.message);
      }
    }

    // 清除聊天记录（包括 localStorage 和页面显示）
    function clearChat() {
      chatHistory = [];
      updateLocalStorage();
      chatLog.innerHTML = "";
    }

    // 绑定按钮点击事件
    sendBtn.addEventListener('click', () => {
      const message = userInput.value.trim();
      if (message) {
        sendMessage(message);
      }
    });

    clearBtn.addEventListener('click', () => {
      if (confirm("确定要清除聊天记录吗？")) {
        clearChat();
      }
    });

    // 回车键触发发送（不换行）
    userInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendBtn.click();
      }
    });

    // 页面加载时恢复聊天记录
    loadChatHistory();
  </script>
</body>
</html>
