<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>SiliconFlow AI 聊天（localStorage 版）</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #chat-log {
      border: 1px solid #ccc;
      padding: 10px;
      height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-bottom: 10px;
    }
    .user-msg {
      color: blue;
      margin: 5px 0;
    }
    .ai-msg {
      color: green;
      margin: 5px 0;
    }
    .ai-reasoning {
      color: gray;
      margin: 5px 0;
    }
    .system-msg {
      color: purple;
      margin: 5px 0;
    }
    .timestamp {
      font-size: 0.8em;
      color: #666;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <h1>SiliconFlow AI 聊天</h1>
  <div id="chat-log"></div>
  <textarea id="user-input" rows="4" cols="50" placeholder="请输入你的消息..."></textarea><br>
  <button id="send-btn">发送</button>
  <button id="clear-btn">清除聊天记录</button>

  <script>
    // SiliconFlow API 配置
    const API_KEY = "sk-tdebsufltysokmhqqneocnbzipqtamdqoyfzvzpancbewfdy";
    const BASE_URL = "https://api.siliconflow.cn/v1";
    const CHAT_ENDPOINT = BASE_URL + "/chat/completions";

    // 全局对话历史数组（包含系统提示等），每条记录格式：{role, content, timestamp}
    let conversation = [];

    // 从 localStorage 加载聊天记录并在页面显示
    function loadChatHistory() {
      const storedHistory = localStorage.getItem("chatHistory");
      if (storedHistory) {
        conversation = JSON.parse(storedHistory);
        conversation.forEach(msg => {
          appendMessageToLog(msg.role, msg.content, msg.timestamp, false);
        });
      } else {
        // 初始化系统提示消息
        const systemMsg = { role: "system", content: "You are a helpful assistant.", timestamp: Date.now() };
        conversation.push(systemMsg);
        updateLocalStorage();
        appendMessageToLog(systemMsg.role, systemMsg.content, systemMsg.timestamp, false);
      }
    }

    // 更新 localStorage
    function updateLocalStorage() {
      localStorage.setItem("chatHistory", JSON.stringify(conversation));
    }

    // 格式化时间戳
    function formatTimestamp(ts) {
      const date = new Date(ts);
      return date.toLocaleString();
    }

    // 将消息追加到聊天记录显示区域，同时决定是否保存到 conversation 数组
    function appendMessageToLog(role, content, timestamp = Date.now(), save = true) {
      const chatLog = document.getElementById("chat-log");
      const messageElem = document.createElement("div");
      let className = "";
      if (role === "用户") className = "user-msg";
      else if (role === "AI") className = "ai-msg";
      else if (role === "AI（推理中）") className = "ai-reasoning";
      else if (role === "system") className = "system-msg";
      messageElem.className = className;
      messageElem.innerHTML = `<strong>${role}:</strong> ${content} <span class="timestamp">[${formatTimestamp(timestamp)}]</span>`;
      chatLog.appendChild(messageElem);
      chatLog.scrollTop = chatLog.scrollHeight;
      if (save) {
        conversation.push({ role: role, content: content, timestamp: timestamp });
        updateLocalStorage();
      }
    }

    // 清除聊天记录（页面及 localStorage）
    function clearChat() {
      if (confirm("确定要清除聊天记录吗？")) {
        conversation = [];
        localStorage.removeItem("chatHistory");
        document.getElementById("chat-log").innerHTML = "";
      }
    }

    // 调用 SiliconFlow API 实现流式输出
    async function sendMessage(userMsg) {
      // 显示用户消息（保存到 conversation）
      appendMessageToLog("用户", userMsg, Date.now(), true);

      // 构造请求 payload（注意：对话历史中包含系统提示和所有历史消息）
      const payload = {
        model: "Pro/deepseek-ai/DeepSeek-R1",  // 指定模型
        messages: conversation,
        max_tokens: 16384,
        stream: true
      };

      try {
        const response = await fetch(CHAT_ENDPOINT, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + API_KEY
          },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          appendMessageToLog("AI", "错误: " + response.statusText, Date.now(), true);
          return;
        }
        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let aiReply = "";
        // 创建一个占位元素显示推理过程
        const chatLog = document.getElementById("chat-log");
        const reasoningElem = document.createElement("div");
        reasoningElem.className = "ai-reasoning";
        reasoningElem.innerHTML = `<strong>AI（推理中）:</strong> `;
        chatLog.appendChild(reasoningElem);
        chatLog.scrollTop = chatLog.scrollHeight;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, { stream: true });
          // 按行处理数据块（假设每行数据以 "data: " 开头）
          const lines = chunk.split("\n").filter(line => line.trim() !== "");
          for (const line of lines) {
            if (line.startsWith("data: ")) {
              const dataStr = line.slice("data: ".length).trim();
              if (dataStr === "[DONE]") {
                break;
              }
              try {
                const dataJson = JSON.parse(dataStr);
                const delta = dataJson.choices && dataJson.choices[0].delta;
                if (delta) {
                  // 如果存在推理内容且还未开始回复，则显示推理过程
                  if (delta.reasoning_content && !delta.content) {
                    reasoningElem.innerHTML = `<strong>AI（推理中）:</strong> ${aiReply + delta.reasoning_content}`;
                  }
                  // 如果存在回复内容，则认为开始回复阶段
                  if (delta.content) {
                    aiReply += delta.content;
                    reasoningElem.innerHTML = `<strong>AI（推理中）:</strong> ${aiReply}`;
                  }
                }
              } catch (e) {
                console.error("解析数据块错误:", e);
              }
            }
          }
        }
        // 推理结束，删除占位元素并显示最终回复
        reasoningElem.remove();
        appendMessageToLog("AI", aiReply, Date.now(), true);
      } catch (error) {
        console.error("API 调用错误:", error);
        appendMessageToLog("AI", "错误: " + error.message, Date.now(), true);
      }
    }

    // 绑定发送和清除按钮事件
    document.getElementById("send-btn").addEventListener("click", () => {
      const inputElem = document.getElementById("user-input");
      const message = inputElem.value.trim();
      if (message) {
        sendMessage(message);
        inputElem.value = "";
      }
    });

    document.getElementById("clear-btn").addEventListener("click", clearChat);

    // 页面加载时恢复历史记录
    loadChatHistory();
  </script>
</body>
</html>
