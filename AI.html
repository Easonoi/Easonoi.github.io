<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>SiliconFlow AI 聊天（localStorage 版）</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #chat-log {
      border: 1px solid #ccc;
      padding: 10px;
      height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-bottom: 10px;
    }
    .system-msg {
      color: purple;
      margin: 5px 0;
    }
    .user-msg {
      color: blue;
      margin: 5px 0;
    }
    .assistant-msg {
      color: green;
      margin: 5px 0;
    }
    .assistant-reasoning {
      color: gray;
      margin: 5px 0;
    }
    .timestamp {
      font-size: 0.8em;
      color: #666;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <h1>SiliconFlow AI 聊天</h1>
  <div id="chat-log"></div>
  <textarea id="user-input" rows="4" cols="50" placeholder="请输入你的消息..."></textarea><br>
  <button id="send-btn">发送</button>
  <button id="clear-btn">清除聊天记录</button>

  <script>
    // ========== SiliconFlow API 配置 ==========
    const API_KEY = "sk-tdebsufltysokmhqqneocnbzipqtamdqoyfzvzpancbewfdy";
    const BASE_URL = "https://api.siliconflow.cn/v1";
    const CHAT_ENDPOINT = BASE_URL + "/chat/completions";
    // 使用 deepseek-ai/DeepSeek-R1 模型；如果不确定是否可用，可尝试 "gpt-3.5-turbo" 等
    const MODEL_NAME = "Pro/deepseek-ai/DeepSeek-R1";

    // ========== 对话历史：每条记录必须用英文 role(system/user/assistant) ==========
    let conversation = [];

    // 页面加载时，初始化或恢复对话历史
    function loadChatHistory() {
      const storedHistory = localStorage.getItem("chatHistory");
      if (storedHistory) {
        conversation = JSON.parse(storedHistory);
        // 显示已存在的记录
        conversation.forEach(msg => {
          appendMessageToLog(msg.role, msg.content, msg.timestamp, false);
        });
      } else {
        // 若无历史记录，先加一个 system 提示
        const systemMsg = {
          role: "system",
          content: "You are a helpful assistant.",
          timestamp: Date.now()
        };
        conversation.push(systemMsg);
        updateLocalStorage();
        appendMessageToLog(systemMsg.role, systemMsg.content, systemMsg.timestamp, false);
      }
    }

    // 更新 localStorage
    function updateLocalStorage() {
      localStorage.setItem("chatHistory", JSON.stringify(conversation));
    }

    // 格式化时间
    function formatTimestamp(ts) {
      const date = new Date(ts);
      return date.toLocaleString();
    }

    // 映射 role -> 显示用中文 & CSS class
    function getDisplayInfoByRole(role) {
      switch (role) {
        case "system":    return { label: "系统", className: "system-msg" };
        case "user":      return { label: "用户", className: "user-msg" };
        case "assistant": return { label: "AI",   className: "assistant-msg" };
        // 这里可根据需要扩展更多角色
        default:          return { label: role,   className: "assistant-msg" };
      }
    }

    // 追加消息到页面日志
    // 其中 role 必须是 system/user/assistant；显示时再映射成中文
    function appendMessageToLog(role, content, timestamp = Date.now(), save = true) {
      const chatLog = document.getElementById("chat-log");
      const { label, className } = getDisplayInfoByRole(role);

      const messageElem = document.createElement("div");
      messageElem.className = className;
      messageElem.innerHTML = `
        <strong>${label}:</strong> ${content}
        <span class="timestamp">[${formatTimestamp(timestamp)}]</span>
      `;
      chatLog.appendChild(messageElem);
      chatLog.scrollTop = chatLog.scrollHeight;

      if (save) {
        conversation.push({ role, content, timestamp });
        updateLocalStorage();
      }
    }

    // 清除聊天
    function clearChat() {
      if (confirm("确定要清除聊天记录吗？")) {
        conversation = [];
        localStorage.removeItem("chatHistory");
        document.getElementById("chat-log").innerHTML = "";
      }
    }

    // 调用 SiliconFlow API（流式）
    async function sendMessage(userMsg) {
      // 先把用户消息存入对话（role = user）
      appendMessageToLog("user", userMsg, Date.now(), true);

      // 构造请求体：messages 数组要用英文 role
      const payload = {
        model: MODEL_NAME,
        messages: conversation.map(item => ({
          // 这里的 role 必须是 system/user/assistant
          role: item.role,
          content: item.content
        })),
        max_tokens: 16384,
        stream: true
      };

      try {
        const response = await fetch(CHAT_ENDPOINT, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + API_KEY
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          appendMessageToLog("assistant", "错误: " + response.statusText, Date.now(), true);
          return;
        }

        // 处理流式输出
        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let aiReply = "";

        // 在页面显示“AI（推理中）”占位
        const chatLog = document.getElementById("chat-log");
        const reasoningElem = document.createElement("div");
        reasoningElem.className = "assistant-reasoning";
        reasoningElem.innerHTML = `<strong>AI（推理中）:</strong> `;
        chatLog.appendChild(reasoningElem);
        chatLog.scrollTop = chatLog.scrollHeight;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value, { stream: true });
          // 逐行处理
          const lines = chunk.split("\n").filter(line => line.trim() !== "");
          for (const line of lines) {
            if (line.startsWith("data: ")) {
              const dataStr = line.slice("data: ".length).trim();
              if (dataStr === "[DONE]") {
                break;
              }
              try {
                const dataJson = JSON.parse(dataStr);
                // delta 里若有 content，则拼接到 aiReply
                const delta = dataJson.choices?.[0]?.delta;
                if (delta?.content) {
                  aiReply += delta.content;
                  // 实时更新“推理中”显示
                  reasoningElem.innerHTML = `<strong>AI（推理中）:</strong> ${aiReply}`;
                }
              } catch (err) {
                console.error("解析数据块错误:", err);
              }
            }
          }
        }

        // 移除“推理中”占位，显示最终回复（role = assistant）
        reasoningElem.remove();
        appendMessageToLog("assistant", aiReply, Date.now(), true);
      } catch (error) {
        console.error("API 调用错误:", error);
        appendMessageToLog("assistant", "错误: " + error.message, Date.now(), true);
      }
    }

    // 绑定按钮
    document.getElementById("send-btn").addEventListener("click", () => {
      const inputElem = document.getElementById("user-input");
      const message = inputElem.value.trim();
      if (message) {
        sendMessage(message);
        inputElem.value = "";
      }
    });

    document.getElementById("clear-btn").addEventListener("click", clearChat);

    // 页面加载时恢复历史记录
    loadChatHistory();
  </script>
</body>
</html>
